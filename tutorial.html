<!DOCTYPE html>
  <head>
    <title>remoteStorage.js tutorial</title>
    <meta charset="utf-8">
    <script src="http://unhosted.org/require.js"></script>
    <script>
      require(['./unhosted/remoteStorage-0.4.5'], function(remoteStorage) {

        document.getElementById('connectButton').onclick = function() {
          localStorage.userAddress=document.getElementById('userAddress').value;
          remoteStorage.getStorageInfo(localStorage.userAddress, function(err, storageInfo) {
            if(err) {
              alert('no, sorry!');
            } else {
              alert('yes! look: '+JSON.stringify(storageInfo));
              localStorage.currUserStorageInfo = JSON.stringify(storageInfo);
            }
          });
        }

        document.getElementById('doOAuthButton').onclick =  function() {
          var storageInfo = JSON.parse(localStorage.currUserStorageInfo);
          var categories = ['public','documents'];
          var redirectUri=location.protocol+'//'+location.host+'/rcvToken.html';
          //window.open(redirectUri+'#access_token=abc');
          window.open(remoteStorage.createOAuthAddress(storageInfo, categories, redirectUri));
          window.addEventListener('message', function(event) {
            if(event.origin == location.protocol +'//'+ location.host) {
              localStorage.bearerToken = event.data;
            }
          }, false);
        }
        document.getElementById('uploadFooDocButton').onclick = function() {
          var dataToUpload= 'Buffalo Buffalo Buffalo Buffalo buffalo buffalo Buffalo Buffalo';
          var storageInfo = JSON.parse(localStorage.currUserStorageInfo);
          var documentsClient = remoteStorage.createClient(storageInfo, 'documents', localStorage.bearerToken);
          documentsClient.put('foo', dataToUpload, function(err) {
            if(err) {
              alert('Oops! '+err);
            } else {
              alert('uploaded "'+dataToUpload+'" to //'+localStorage.userAddress+'/documents#foo');
            }
          });
        }
        document.getElementById('publishFooDocButton').onclick = function() {
          var storageInfo = JSON.parse(localStorage.currUserStorageInfo);
          var publicClient = remoteStorage.createClient(storageInfo, 'public', localStorage.bearerToken);
          var documentsClient = remoteStorage.createClient(storageInfo, 'documents', localStorage.bearerToken);
          documentsClient.get('foo', function(err, data) {
            if(err) {
              alert('Oops get! '+err);
            } else {
              alert('got data "'+data+'", now putting');
              publicClient.put('foo', data, function(err2) {
                if(err2) {
                  alert('Oops put! '+err);
                } else {
                  alert('copied //'+localStorage.userAddress+'/documents#foo to //'+localStorage.userAddress+'/public#foo');
                  documentsClient.delete('foo', function(err, data) {
                    if(err) {
                      alert('Oops delete! '+err);
                    } else {
                      alert('and deleted //'+localStorage.userAddress+'/documents#foo');
                    }
                  });
                }
              });
            }
          });
        }
        document.getElementById('getPublicFooButton').onclick = function() {
          remoteStorage.getStorageInfo(localStorage.userAddress, function(err, storageInfo) {
            if(err) {
              alert('could not find the remote storage of '+userAddress);
            } else {
              var client = remoteStorage.createClient(storageInfo, 'public');
              client.get('foo', function(err, data) {
                if(err) {
                  alert('could not find foo on the remote storage of '+userAddress);
                } else {
                  alert(data);
                }
              });
            }
          });
        }
      });
    </script>
  </head>
  <body>
    <input id="userAddress" value="test@surf.unhosted.org">
    <input type="submit" value="Connect" id="connectButton">
    <input type="submit" value="Do OAuth" id="doOAuthButton">
    <input type="submit" value="Upload foo doc" id="uploadFooDocButton">
    <input type="submit" value="Publish foo doc" id="publishFooDocButton">
    <input type="submit" value="Get public foo" id="getPublicFooButton">
    <p><strong>Please note:</strong> We're still working on all of this, if you have any trouble, please come to <a href="http://webchat.freenode.net/?channels=unhosted">the #unhosted chatroom</a> on freenode.
    </p>
  </body>
</html>
