<!DOCTYPE html>
  <head>
    <title>remoteStorage.js tutorial</title>
    <meta charset="utf-8">
    <script src="http://unhosted.org/require.js"></script>
    <script>
      require(['http://unhosted.org/remoteStorage-0.4.2.js'], function(remoteStorage) {

        document.getElementById('connectButton').onclick = function() {
          var userAddress=document.getElementById('userAddress').value;
          remoteStorage.getStorageInfo(userAddress, function(err, storageInfo) {
            if(err) {
              alert('no, sorry!');
            } else {
              alert('yes! look: '+JSON.stringify(storageInfo));
              localStorage.currUserStorageInfo = JSON.stringify(storageInfo);
            }
          });
        }

        document.getElementById('getPublicFooButton').onclick = function() {
          var userAddress=document.getElementById('userAddress').value;
          remoteStorage.getStorageInfo(userAddress, function(err, storageInfo) {
            if(err) {
              alert('could not find the remote storage of '+userAddress);
            } else {
              var client = remoteStorage.createClient(storageInfo, 'public');
              client.get('foo', function(err, data) {
                if(err) {
                  alert('could not find foo on the remote storage of '+userAddress);
                } else {
                  alert(data);
                }
              });
            }
          });
        }
        document.getElementById('doOAuthButton').onclick =  function() {
          //FOR TESTING: var popup = window.open('http://myfavouritesandwich.org/rcvToken.html#access_token=a&b=c');
          var popup = window.open(
            remoteStorage.createOAuthAddress(
              JSON.parse(localStorage.currUserStorageInfo),
              ['public', 'pictures'],
              'https://myfavouritesandwich.org/rcvToken.html'
            )
          );
          window.addEventListener('message', function(event) {
            if(event.origin != location.protocol +'//'+ location.host) {
              alert('Got unexpected message from '+event.origin);
            } else {
              if(event.data.substring(0, 'TOKEN:'.length) == 'TOKEN:') {
                localStorage.bearerToken = event.data.substring('TOKEN:'.length);
              }
            }
          }, false);
        }
        document.getElementById('setPhotoAsAvatarButton').onclick = function() {
          var storageInfo = JSON.parse(localStorage.currUserStorageInfo);
          var publicClient = remoteStorage.createClient(storageInfo, 'public', localStorage.bearerToken);
          var picturesClient = remoteStorage.createClient(storageInfo, 'pictures', localStorage.bearerToken);
          picturesClient.get('foto01', function(err, data) {
            publicClient.put('avatar', data, function(err, data) {
              alert('copied //user@host/pictures#foto01 to //user@host/public#avatar');
            });
          });
        }
      });
    </script>
  </head>
  <body>
    <input id="userAddress" type="text">
    <input type="submit" value="Connect" id="connectButton">
    <input type="submit" value="Get public foo" id="getPublicFooButton">
    <input type="submit" value="Do OAuth" id="doOAuthButton">
    <input type="submit" value="Set Photo as Avatar" id="setPhotoAsAvatarButton">
    <p><strong>Please note:</strong> We're having some trouble with the BrowserID-based OAuth on Iris Couch. That means you cannot actually use this page right now if you got your remoteStorage account through Libre Docs. We are working to fix this soon, sorry!</p>
  </body>
</html>
