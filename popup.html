<html>
<head>
<script>
function login(username) {
	if(username === null) {
		alert('please put your breakpoint on line 38');
		return;
	}
	var parts = username.split('@');
	var user = parts[0];
	var domain = parts[1];
        var req = new XMLHttpRequest();
        req.onreadystatechange=function()
          {
          if (req.readyState==4 && req.status==200)
            {
            processHostMeta(req.responseText);
            }
          }
        req.open("GET", "http://"+domain+"/.well-known/host-meta?format=json", true);
        req.send();
}
function processHostMeta(text) {
        var template = JSON.parse(text).links.lrdd[0].template;
	var req = new XMLHttpRequest();
	req.onreadystatechange=function()
          {
          if (req.readyState==4 && req.status==200)
            {
            processWebFinger(req.responseText);
            }
          }
        req.open("GET", template.replace("{uri}", "acct:"+
		localStorage.getItem('user_name')), true);
        req.send();
}
function processWebFinger(text) {
	var uDAVdomain = JSON.parse(text).links["http:\/\/unhosted.org\/spec\/DAV\/"];
	var app = "www.myfavouritesandwich.org";
	window.location=uDAVdomain+"oauth2/auth?client_id="+app+"&redirect_uri="+app+"/cb.html&scope=dav&response_type=token&user_name="
		+localStorage.getItem('user_name');
}

</script>
</head>
<body onload="login(localStorage.getItem('user_name'));">
</body>
</html>
