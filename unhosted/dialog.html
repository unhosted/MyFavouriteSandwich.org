<!DOCTYPE html>
  <head>
    <title>Closing dialog...</title>
    <meta charset="utf-8">
    <script src="./remoteStorage-0.5.3.js"></script>
    <script>
      function gup(name) {
        name = name.replace(/[\[]/,'\\\[').replace(/[\]]/,'\\\]');
        var regexS = '[\\?&]'+name+'=([^&#]*)';
        var regex = new RegExp(regexS);
        var results = regex.exec(window.location.href);
        if(results == null) {
          return "";
        } else {
          return results[1];
        }
      }
      var storageInfo = JSON.parse(localStorage.getItem('_juggleStorageInfo'));
      if(storageInfo) {
        document.write('Closing dialog...');
        localStorage.removeItem('_juggleStorageInfo');
        window.opener.postMessage('conn:'+JSON.stringify({
          storageInfo: storageInfo,
          bearerToken: remoteStorage.receiveToken()
        }), location.protocol+'//'+location.host);
        window.close();
      } else {
        document.write('Opening dialog...');
        var userAddress = decodeURIComponent(gup('userAddress'));
        var categories = JSON.parse(decodeURIComponent(gup('categories')));
        var libPath = decodeURIComponent(gup('libPath'));
        remoteStorage.getStorageInfo(userAddress, function(err, storageInfo) {
          if(err) {
            window.opener.postMessage('conn:'+JSON.stringify({
              err: err
            }), location.protocol+'//'+location.host);
            window.close();
          } else {
            localStorage.setItem('_juggleStorageInfo', JSON.stringify(storageInfo));
            var oauthAddress = remoteStorage.createOAuthAddress(storageInfo, categories, location.protocol+'//'+location.host+libPath+'/closeDialog.html');
            window.location = oauthAddress;
          }
        });
      }
    </script>
  </head>
  <body>
  </body>
</html>
